# فاز سوم: صحنه‌های نوری

در این مرحله، پروژه دیمر را با قابلیت تعریف و فراخوانی صحنه‌های نوری ارتقا می بخشیم. این قابلیت به کاربر اجازه می‌دهد تا تنظیمات روشنایی دلخواه خود را ذخیره کرده و با فشردن یک کلید، آن‌ها را فعال نماید.

---

## ۱. تغییرات سخت‌افزاری

برای پیاده‌سازی این قابلیت، سه کلید فشاری (Push Button) به عنوان کلیدهای صحنه به مدار اضافه می‌شوند.

* **اتصالات:** کلیدهای `Scene01_key`, `Scene02_key`, و `Scene03_key` به ترتیب به پین‌های دیجیتال D5, D4, و D6 آردوینو متصل می‌شوند. سمت دیگر هر کلید به GND وصل شده و برای خواندن وضعیت آنها، از مقاومت‌های Pull-up داخلی آردوینو (`INPUT_PULLUP`) استفاده می‌شود.

---

## ۲. منطق جدید نرم‌افزار: مدیریت پیشرفته حالت‌ها

سیستم اکنون دارای یک منطق اولویت‌بندی شده برای کنترل است که تجربه کاربری هوشمندانه‌ای را فراهم می‌کند:

**اولویت ۱: کنترل دستی > اولویت ۲: کنترل صحنه > اولویت ۳: کنترل خودکار**

### حالت‌ها و اولویت‌ها

برنامه در یکی از سه حالت `MANUAL`, `SCENE`, یا `AUTO` قرار دارد. کنترل دستی با پتانسیومتر همیشه بالاترین اولویت را دارد و هرگونه تنظیم توسط آن، حالت‌های دیگر را لغو می‌کند.

#### حالت ۱: کنترل خودکار (AUTO_MODE)

این حالت پایه و پیش‌فرض سیستم است.

* **اقدام در این حالت:** روشنایی لامپ به طور مداوم بر اساس مقدار خوانده شده از سنسور LDR تنظیم می‌شود.
* **انتقال‌های خروجی:**
    * **رویداد:** کاربر پتانسیومتر را می‌چرخاند.
        * **انتقال:** `AUTO_MODE -> MANUAL_MODE`
        * **عملیات:** زمان آخرین تنظیم دستی ثبت می‌شود.
    * **رویداد:** کاربر یک کلید صحنه را کوتاه فشار می‌دهد.
        * **انتقال:** `AUTO_MODE -> SCENE_MODE`
        * **عملیات:** حالت فعلی (`AUTO`) و روشنایی فعلی ذخیره شده و تایمر ۳۰ ثانیه‌ای صحنه فعال می‌شود.

#### حالت ۲: کنترل دستی (MANUAL_MODE)

این حالت بالاترین اولویت را دارد و هر زمان فعال شود، تمام حالت‌های دیگر را لغو می‌کند.

* **اقدام در این حالت:** روشنایی لامپ مستقیماً از مقدار پتانسیومتر تبعیت می‌کند.
* **انتقال‌های خروجی:**
    * **رویداد:** کاربر پتانسیومتر را دوباره می‌چرخاند.
        * **انتقال:** `MANUAL_MODE -> MANUAL_MODE` (در همین حالت می‌ماند).
        * **عملیات:** تایمر ۱۰ ثانیه‌ای عدم فعالیت، ریست می‌شود.
    * **رویداد:** کاربر یک کلید صحنه را کوتاه فشار می‌دهد.
        * **انتقال:** `MANUAL_MODE -> SCENE_MODE`
        * **عملیات:** حالت فعلی (`MANUAL`) و روشنایی فعلی ذخیره شده و تایمر ۳۰ ثانیه‌ای صحنه فعال می‌شود.
    * **رویداد:** عدم فعالیت کاربر.
        * **شرط:** `(زمان فعلی - آخرین زمان تنظیم) > ۱۰ ثانیه`
        * **انتقال:** `MANUAL_MODE -> AUTO_MODE`

#### حالت ۳: صحنه (SCENE_MODE)

این یک حالت موقت است که با فراخوانی یک صحنه فعال می‌شود.

* **اقدام در این حالت:** روشنایی لامپ بر اساس مقدار ذخیره شده در EEPROM برای آن صحنه خاص، تنظیم می‌شود.
* **انتقال‌های خروجی:**
    * **رویداد:** کاربر پتانسیومتر را می‌چرخاند (بالاترین اولویت).
        * **انتقال:** `SCENE_MODE -> MANUAL_MODE`
    * **رویداد:** پایان زمان صحنه.
        * **شرط:** `(زمان فعلی - زمان فعال‌سازی صحنه) > ۳۰ ثانیه`
        * **انتقال:** `SCENE_MODE -> preSceneMode` (بازگشت به حالتی که قبل از صحنه فعال بود یعنی AUTO یا MANUAL).

### اقدام ویژه: ذخیره صحنه (فشار بلند)

این یک عملیات است و باعث تغییر حالت نمی‌شود.

* **رویداد:** کاربر هر یک از کلیدهای صحنه را برای بیش از ۵ ثانیه نگه می‌دارد.
* **عملیات:**
    1.  مقدار روشنایی فعلی (که توسط پتانسیومتر تعیین شده) خوانده می‌شود.
    2.  این مقدار در آدرس مربوط به آن صحنه در حافظه EEPROM نوشته می‌شود.
    3.  یک بازخورد بصری (چشمک سریع LED) برای تأیید ذخیره، نمایش داده می‌شود.

### تشخیص فشار کوتاه و بلند

* **فشار کوتاه (Short Press):** اگر کلید صحنه فشرده و قبل از ۵ ثانیه رها شود، سیستم وارد حالت `SCENE` شده و تنظیمات روشنایی مربوط به آن صحنه از حافظه EEPROM فراخوانی و اعمال می‌شود.
* **فشار بلند (Long Press):** اگر کلید برای مدت ۵ ثانیه یا بیشتر نگه داشته شود، مقدار روشنایی فعلی (که با پتانسیومتر تنظیم شده) در حافظه EEPROM برای آن صحنه ذخیره می‌گردد.

### مدیریت Timeout هوشمند

* **تایم‌اوت حالت دستی:** اگر سیستم در حالت `MANUAL` باشد و کاربر برای ۱۰ ثانیه پتانسیومتر را تغییر ندهد، سیستم به صورت خودکار به حالت `AUTO` بازمی‌گردد.
* **تایم‌اوت حالت صحنه:** وقتی یک صحنه فعال می‌شود، یک تایمر ۳۰ ثانیه‌ای شروع به کار می‌کند. قبل از فعال‌سازی صحنه، حالت قبلی سیستم (دستی یا خودکار) و میزان روشنایی آن ذخیره می‌شود. پس از اتمام ۳۰ ثانیه، سیستم به طور خودکار به همان حالت و روشنایی قبلی بازمی‌گردد.

### حافظه پایدار (EEPROM)

با استفاده از کتابخانه `<EEPROM.h>`، مقادیر روشنایی هر صحنه (عددی بین 0 تا 1023) در حافظه دائمی میکروکنترلر ذخیره می‌شود. این ویژگی تضمین می‌کند که حتی با قطع و وصل شدن برق، تنظیمات صحنه‌های کاربر از بین نرود.

---

## ۳. بهبود تجربه کاربری: بازخورد بصری

برای اینکه کاربر از عملکرد سیستم مطلع شود، از LED داخلی آردوینو (پین ۱۳) به عنوان یک نشانگر بازخورد استفاده می‌شود:

* **هنگام ذخیره صحنه:** LED به سرعت برای چند لحظه چشمک می‌زند تا موفقیت‌آمیز بودن عملیات ذخیره را تأیید کند.
* **هنگام فراخوانی صحنه:** LED به تعداد شماره آن صحنه چشمک می‌زند (مثلاً برای صحنه ۲، دو بار چشمک می‌زند).