# فاز چهارم: هوشمندسازی با سنسور حرکت (PIR)

در این فاز، پروژه دیمر با تلفیق یک سنسور تشخیص حرکت (PIR)، به یک سیستم روشنایی تطبیق‌پذیر تبدیل می‌شود. هدف اصلی این ارتقا، توانمندسازی سیستم برای تشخیص هوشمند حضور افراد و واکنش خودکار به آن است، که موجب استقلال کامل و بهینه‌سازی عملکرد دیمر می‌شود.

## ویژگی‌های جدید در این فاز

* **افزودن سنسور حرکت (PIR):** یک سنسور PIR به مدار اضافه شده است تا حضور یا عدم حضور افراد در اتاق را تشخیص دهد.
* **حالت کنترل جدید "تشخیص حرکت" (Motion Mode):** یک حالت نرم‌افزاری جدید به منطق کنترلر اضافه شده که با تشخیص حرکت فعال می‌شود.
* **روشنایی هوشمند در هنگام تشخیص حرکت:** مهم‌ترین ویژگی این فاز، نحوه واکنش سیستم به حرکت است. به جای روشن شدن لامپ با حداکثر توان، شدت روشنایی بر اساس نور محیط (که توسط سنسور LDR اندازه‌گیری می‌شود) تنظیم می‌گردد.

## اولویت‌بندی جدید کنترل‌ها

با اضافه شدن حالت تشخیص حرکت، اولویت‌بندی کنترل‌ها برای جلوگیری از تداخل و ایجاد یک عملکرد منطقی، به شرح زیر به‌روزرسانی شد:

1.  **کنترل دستی (پتانسیومتر):** بالاترین اولویت را دارد. هر زمان که کاربر پتانسیومتر را بچرخاند، کنترل کامل را در دست می‌گیرد.
2.  **تشخیص حرکت (PIR):** در صورت عدم دخالت دستی، این حالت اولویت بعدی را دارد. اگر حرکتی تشخیص داده شود، این حالت بر حالت‌های صحنه و خودکار ارجحیت پیدا می‌کند.
3.  **کنترل صحنه (دکمه‌ها):** اگر کاربر به صورت دستی دخالت نکند و حرکتی نیز در محیط نباشد، می‌تواند صحنه‌های از پیش ذخیره‌شده را فراخوانی کند.
4.  **حالت خودکار (LDR):** پایین‌ترین اولویت و حالت پیش‌فرض سیستم. زمانی که هیچ یک از رویدادهای بالا رخ ندهد، دیمر نور را بر اساس نور محیط تنظیم می‌کند.

## حالت‌ها (States)

1.  **AUTO (حالت پایه و پیش‌فرض)**
    * **وظیفه:** در این حالت، سیستم به طور مداوم نور محیط را با سنسور LDR می‌خواند و روشنایی لامپ را بر اساس آن تنظیم می‌کند (محیط تاریک = نور زیاد، محیط روشن = نور کم). این حالت، وضعیت استراحت سیستم است که پس از پایان سایر حالت‌ها به آن بازمی‌گردد.

2.  **MOTION (حالت تشخیص حرکت)**
    * **وظیفه:** این حالت با تشخیص حضور فرد فعال می‌شود. در این وضعیت نیز روشنایی لامپ بر اساس نور محیط (LDR) تنظیم می‌شود تا تجربه‌ای هوشمند و بهینه ارائه دهد. این حالت دارای یک تایمر است.

3.  **SCENE (حالت فراخوانی صحنه)**
    * **وظیفه:** کاربر یک صحنه روشنایی از پیش تعریف‌شده را فعال کرده است. روشنایی لامپ روی مقدار ذخیره‌شده برای آن صحنه ثابت می‌ماند. این حالت نیز دارای تایمر است.

4.  **MANUAL (حالت کنترل دستی)**
    * **وظیفه:** کاربر کنترل کامل را در دست گرفته است. روشنایی لامپ دقیقاً از مقدار پتانسیومتر پیروی می‌کند. این حالت بالاترین اولویت را دارد و دارای تایمر است.

## رویدادها و انتقال‌ها (Events & Transitions)

در اینجا، تمام رویدادهایی که باعث تغییر حالت سیستم می‌شوند، به ترتیب اولویت شرح داده شده‌اند:

### رویداد ۱: چرخاندن پتانسیومتر (بالاترین اولویت)
* **شرط:** کاربر پتانسیومتر را حرکت می‌دهد.
* **انتقال:** سیستم از هر حالتی که در آن قرار دارد (`AUTO`, `SCENE`, یا `MOTION`) فوراً به حالت `MANUAL` منتقل می‌شود.
    * `ANY_STATE → MANUAL`

### رویداد ۲: تشخیص حرکت
* **شرط:** سنسور PIR حرکتی را تشخیص می‌دهد.
* **انتقال:** اگر سیستم در حالت `MANUAL` نباشد، از حالت `AUTO` یا `SCENE` به حالت `MOTION` منتقل می‌شود. تایمر حالت `MOTION` نیز فعال یا بازنشانی (reset) می‌شود.
    * `AUTO → MOTION`
    * `SCENE → MOTION`

### رویداد ۳: فشردن دکمه صحنه (کوتاه)
* **شرط:** کاربر یکی از دکمه‌های صحنه را به صورت کوتاه فشار می‌دهد.
* **انتقال:** اگر سیستم در حالت `MANUAL` یا `MOTION` نباشد، از حالت `AUTO` به حالت `SCENE` منتقل می‌شود.
    * `AUTO → SCENE`

### رویداد ۴: تایم‌اوت حالت دستی (Timeout)
* **شرط:** سیستم در حالت `MANUAL` است و کاربر برای مدتی (مثلاً ۱۰ ثانیه) پتانسیومتر را حرکت نداده است.
* **انتقال:** سیستم از حالت `MANUAL` به حالت پایه، یعنی `AUTO`، بازمی‌گردد.
    * `MANUAL → AUTO`

### رویداد ۵: تایم‌اوت حالت حرکت (Timeout)
* **شرط:** سیستم در حالت `MOTION` است، دیگر حرکتی تشخیص داده نمی‌شود و تایمر آن (مثلاً ۶۰ ثانیه) به پایان رسیده است.
* **انتقال:** سیستم از حالت `MOTION` به حالتی که قبل از آن فعال بود (`previousMode` که می‌تواند `AUTO` یا `SCENE` باشد) بازمی‌گردد.
    * `MOTION → previousMode`

### رویداد ۶: تایم‌اوت حالت صحنه (Timeout)
* **شرط:** سیستم در حالت `SCENE` است و تایمر آن (مثلاً ۳۰ ثانیه) به پایان رسیده است.
* **انتقال:** سیستم از حالت `SCENE` به حالتی که قبل از آن فعال بود (`previousMode` که معمولاً `AUTO` است) بازمی‌گردد.
    * `SCENE → previousMode` (معمولاً AUTO)

این ساختار به وضوح نشان می‌دهد که `MANUAL` بر همه چیز اولویت دارد، پس از آن `MOTION`، سپس `SCENE` و در نهایت `AUTO` به عنوان حالت پایه عمل می‌کند. تایم‌اوت‌ها نیز مکانیزمی برای بازگرداندن سیستم به حالت استراحت و پیش‌بینی‌پذیر هستند.

---

## وابستگی‌ها و نصب کتابخانه (Dependencies & Library Installation)

برای شبیه‌سازی صحیح فاز چهارم پروژه، لازم است کتابخانه قطعه سنسور PIR به نرم‌افزار پروتئوس شما اضافه شود. بدون این کتابخانه، پروتئوس قادر به شناسایی و شبیه‌سازی این سنسور نخواهد بود.

### فایل‌های مورد نیاز

تمام فایل‌های ضروری برای نصب این کتابخانه در پوشه پروژه و در مسیر زیر قرار داده شده‌اند:
`EmbeddedSys-HomeLight\simulation\Dimmer_phase04\PIR-Sensor-dependencies\`
در این مسیر، پوشه‌هایی حاوی فایل‌های با پسوند `.LIB` و `.MODEL` را خواهید یافت که برای نصب مورد نیاز هستند.

### مراحل نصب دستی کتابخانه

برای افزودن این کتابخانه به پروتئوس، لطفاً مراحل زیر را با دقت دنبال کنید:

#### ۱. پیدا کردن پوشه DATA در محل نصب پروتئوس
ابتدا باید پوشه `DATA` را در محل نصب پروتئوس روی سیستم خود پیدا کنید. این پوشه معمولاً در یکی از دو مسیر زیر قرار دارد:

* **مسیر اصلی (برای اکثر نسخه‌ها):**
    `C:\Program Files (x86)\Labcenter Electronics\Proteus 8 Professional\DATA`
* **مسیر جایگزین (مخصوص برخی نسخه‌ها):**
    `C:\ProgramData\Labcenter Electronics\Proteus 8 Professional\DATA`

> **نکته:** پوشه `ProgramData` ممکن است به صورت پیش‌فرض مخفی (Hidden) باشد. برای نمایش آن، در File Explorer به تب **View** رفته و تیک گزینه **Hidden items** را فعال کنید.

#### ۲. کپی کردن فایل‌های کتابخانه (`.LIB`)
1.  به پوشه `PIR-Sensor-dependencies` در پروژه بروید.
2.  محتویات پوشه `LIB` (فایلی با پسوند `.LIB`) را کپی کنید.
3.  این فایل‌ها را در پوشه `LIBRARY` که داخل پوشه `DATA` پروتئوس قرار دارد، جای‌گذاری (Paste) کنید.
    * **مسیر نهایی:** `...\Proteus 8 Professional\DATA\LIBRARY`

#### ۳. کپی کردن فایل‌های مدل (`.MODEL`)
1.  دوباره به پوشه `PIR-Sensor-dependencies` بازگردید.
2.  محتویات پوشه `MODEL` (فایل‌هایی با پسوند `.MODEL`) را کپی کنید.
3.  این فایل‌ها را در پوشه `MODELS` که داخل پوشه `DATA` پروتئوس قرار دارد، جای‌گذاری کنید.
    * **مسیر نهایی:** `...\Proteus 8 Professional\DATA\MODELS`

#### ۴. راه‌اندازی مجدد پروتئوس
برای اینکه پروتئوس کتابخانه جدید را شناسایی کند، حتماً نرم‌افزار را به طور کامل ببندید و مجدداً اجرا نمایید.

#### ۵. تأیید نصب
پس از باز کردن پروتئوس، از منوی قطعات (Pick Device) با فشردن کلید **'P'**، نام سنسور **"PIR Sensor"** را جستجو کنید. اگر قطعه در لیست نمایش داده شد، یعنی کتابخانه با موفقیت نصب شده است و می‌توانید از آن در شبیه‌سازی استفاده کنید.