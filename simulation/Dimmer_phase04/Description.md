<div dir="rtl">

# فاز چهارم: هوشمندسازی با سنسور حرکت (PIR)

در این فاز، پروژه دیمر با تلفیق یک سنسور تشخیص حرکت (PIR)، به یک سیستم روشنایی هوشمند و تطبیق‌پذیر تبدیل می‌شود. هدف اصلی این ارتقا، توانمندسازی سیستم برای تشخیص حضور افراد و واکنش خودکار به آن است که موجب استقلال و بهینه‌سازی عملکرد دیمر می‌گردد. کد در این فاز به یک **ماشین حالت محدود (Finite State Machine - FSM)** بازنویسی شده تا مدیریت حالات و انتقالات، قابل اعتماد و قابل توسعه باشد.

## ویژگی‌های جدید در این فاز

* **افزودن سنسور حرکت (PIR):** یک سنسور PIR به مدار اضافه شده است تا حضور یا عدم حضور افراد در اتاق را تشخیص دهد.
* **حالت کنترل جدید "تشخیص حرکت" (Motion Mode):** یک حالت نرم‌افزاری جدید به منطق کنترلر اضافه شده که با تشخیص حرکت فعال می‌شود.
* **روشنایی هوشمند در هنگام تشخیص حرکت:** به جای روشن شدن لامپ با حداکثر توان، شدت روشنایی بر اساس نور محیط (که توسط سنسور LDR اندازه‌گیری می‌شود) تنظیم می‌گردد.
* **معماری کد مبتنی بر ماشین حالت (FSM):** برای مدیریت بهتر اولویت‌ها و انتقالات، کد به صورت یک ماشین حالت ساختاریافته بازنویسی شده است.

---

## اولویت‌بندی کنترل‌ها

با اضافه شدن حالت تشخیص حرکت، اولویت‌بندی کنترل‌ها برای جلوگیری از تداخل و ایجاد یک عملکرد منطقی، به شرح زیر به‌روزرسانی شد:

1.  **کنترل دستی (پتانسیومتر):** بالاترین اولویت را دارد.
2.  **تشخیص حرکت (PIR):** اولویت دوم را دارد و بر حالت‌های صحنه و خودکار ارجح است.
3.  **کنترل صحنه (دکمه‌ها):** اولویت سوم را دارد.
4.  **حالت خودکار (LDR):** پایین‌ترین اولویت و حالت پیش‌فرض سیستم است.

---

## حالت‌ها (States)

1.  **`AUTO` (خودکار):** 🚶‍♂️ حالت پیش‌فرض و پایه. روشنایی توسط سنسور نور (LDR) کنترل می‌شود.
2.  **`MANUAL` (دستی):** 🎛️ بالاترین اولویت. با چرخاندن پتانسیومتر فعال شده و کنترل کامل روشنایی را به کاربر می‌دهد.
3.  **`MOTION` (حرکت):** 🏃 حالت فعال شده توسط سنسور حرکت (PIR). در این حالت، روشنایی بر اساس نور محیط تنظیم می‌شود.
4.  **`SCENE` (صحنه):** 🎬 با فشردن دکمه‌های صحنه فعال می‌شود و یک سطح روشنایی از پیش ذخیره شده را تنظیم می‌کند.

---

## رویدادها و جدول کامل انتقالات (Events & State Transitions)

در زیر، تمام انتقالات ممکن بین حالات مختلف سیستم به همراه عامل ایجادکننده آن‌ها (Trigger) لیست شده است:

| توضیحات | حالت بعدی (To) | عامل انتقال (Trigger) | حالت فعلی (From) |
| ---: | ---: | ---: | ---: |
| بالاترین اولویت؛ هر حالتی را لغو می‌کند. | **`MANUAL`** | حرکت دادن پتانسیومتر | **`AUTO`** |
| اولویت دوم؛ حالت خودکار را لغو می‌کند. | **`MOTION`** | تشخیص حرکت (PIR) | |
| اولویت سوم؛ حالت خودکار را لغو می‌کند. | **`SCENE`** | فشردن کوتاه دکمه صحنه | |
| | | | |
| **تنها راه خروج** از حالت دستی. | **`AUTO`** | تایم‌اوت ۱۰ ثانیه‌ای (عدم استفاده از پتانسیومتر) | **`MANUAL`** |
| | | | |
| لغو حالت حرکت به دلیل اولویت بالاتر. | **`MANUAL`** | حرکت دادن پتانسیومتر | **`MOTION`** |
| بازگشت به حالتی که قبل از تشخیص حرکت فعال بود (معمولاً `AUTO` یا `SCENE`). | **`previousMode`** | تایم‌اوت ۶۰ ثانیه‌ای (پس از آخرین حرکت) | |
| | | | |
| لغو حالت صحنه به دلیل اولویت بالاتر. | **`MANUAL`** | حرکت دادن پتانسیومتر | **`SCENE`** |
| لغو حالت صحنه به دلیل اولویت بالاتر سنسور حرکت. | **`MOTION`** | تشخیص حرکت (PIR) | |
| جابجایی مستقیم بین صحنه‌ها. | **`SCENE`** | فشردن کوتاه دکمه یک **صحنه دیگر** | |
| بازگشت به حالتی که قبل از فعال‌سازی صحنه وجود داشت. | **`previousMode`** | تایم‌اوت ۳۰ ثانیه‌ای | |

---

## وابستگی‌ها و نصب کتابخانه (Dependencies & Library Installation)

برای شبیه‌سازی صحیح فاز چهارم پروژه، لازم است کتابخانه قطعه سنسور PIR به نرم‌افزار پروتئوس شما اضافه شود. بدون این کتابخانه، پروتئوس قادر به شناسایی و شبیه‌سازی این سنسور نخواهد بود.

### فایل‌های مورد نیاز

تمام فایل‌های ضروری برای نصب این کتابخانه در پوشه پروژه و در مسیر زیر قرار داده شده‌اند:
`EmbeddedSys-HomeLight\simulation\Dimmer_phase04\PIR-Sensor-dependencies\`
در این مسیر، پوشه‌هایی حاوی فایل‌های با پسوند `.LIB` و `.MODEL` را خواهید یافت که برای نصب مورد نیاز هستند.

### مراحل نصب دستی کتابخانه

برای افزودن این کتابخانه به پروتئوس، لطفاً مراحل زیر را با دقت دنبال کنید:

#### ۱. پیدا کردن پوشه DATA در محل نصب پروتئوس
ابتدا باید پوشه `DATA` را در محل نصب پروتئوس روی سیستم خود پیدا کنید. این پوشه معمولاً در یکی از دو مسیر زیر قرار دارد:

* **مسیر اصلی (برای اکثر نسخه‌ها):**
    `C:\Program Files (x86)\Labcenter Electronics\Proteus 8 Professional\DATA`
* **مسیر جایگزین (مخصوص برخی نسخه‌ها):**
    `C:\ProgramData\Labcenter Electronics\Proteus 8 Professional\DATA`

> **نکته:** پوشه `ProgramData` ممکن است به صورت پیش‌فرض مخفی (Hidden) باشد. برای نمایش آن، در File Explorer به تب **View** رفته و تیک گزینه **Hidden items** را فعال کنید.

#### ۲. کپی کردن فایل‌های کتابخانه (`.LIB`)
1.  به پوشه `PIR-Sensor-dependencies` در پروژه بروید.
2.  محتویات پوشه `LIB` (فایلی با پسوند `.LIB`) را کپی کنید.
3.  این فایل‌ها را در پوشه `LIBRARY` که داخل پوشه `DATA` پروتئوس قرار دارد، جای‌گذاری (Paste) کنید.
    * **مسیر نهایی:** `...\Proteus 8 Professional\DATA\LIBRARY`

#### ۳. کپی کردن فایل‌های مدل (`.MODEL`)
1.  دوباره به پوشه `PIR-Sensor-dependencies` بازگردید.
2.  محتویات پوشه `MODEL` (فایل‌هایی با پسوند `.MODEL`) را کپی کنید.
3.  این فایل‌ها را در پوشه `MODELS` که داخل پوشه `DATA` پروتئوس قرار دارد، جای‌گذاری کنید.
    * **مسیر نهایی:** `...\Proteus 8 Professional\DATA\MODELS`

#### ۴. راه‌اندازی مجدد پروتئوس
برای اینکه پروتئوس کتابخانه جدید را شناسایی کند، حتماً نرم‌افزار را به طور کامل ببندید و مجدداً اجرا نمایید.

#### ۵. تأیید نصب
پس از باز کردن پروتئوس، از منوی قطعات (Pick Device) با فشردن کلید **'P'**، نام سنسور **"PIR Sensor"** را جستجو کنید. اگر قطعه در لیست نمایش داده شد، یعنی کتابخانه با موفقیت نصب شده است و می‌توانید از آن در شبیه‌سازی استفاده کنید.

</div>
